---
title: "READ_ME"
author: "AÃ¯ssa Morin"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 6
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE, 
                      warning = FALSE) 
                    # cache = FALSE) 
```

```{r}

require(kableExtra)
require(tidyverse)
require(here)
require(ggplot2)
require(readr)

```

## Data preparation

N.B: Copy of the original data from Yolan are in Chapter_2_Dryness... -> documents --> Donnees_Yolan --> Donnee_Yolan_05-2023--> 'Data_Fat_analyses_Yolan'

Original dataset was modified and saved under 'Data_Fat_analyses_raw' in 'Chapter2.Dryness. ... '--> data --> 'Data_Fat_analyses_raw'

Modifications (manual because color coded) on xlxs file -->  column addition: 'collection_interval, values (i.e. Yolan color code)) :  

+ blue  --> early : sample collected within 6 days, 
+ yellow -->  intermediate : sample collected between 6 and 8 days (included ?), 
+ red --> late : sample collected after 8 days (should be exclude from analyses)

Saved as a csv file for R processing 

__Read data__

use function 'read_fat_data_raw()' to read csv file with raw fat data from Yolan

```{r}
# Load functions and deps ?
devtools::load_all()

#DATA PREPARATION ####

# Read data fat analyses raw dataset

fat_data_raw <- read_fat_data_raw()

```


__Clean dataset__

Aim at cleaning, organising and only keep necessary info from fat raw data using the function 'clean_raw_fat_data'

The function :  

+ removes all 'mass_Jxx' columns, 
+ removes columns: "samples_marrow_fat_rate", "samples_marrow_fat_rate_without_residuals", "bone_marrow_fat_rate_mean", "bone_marrow_fat_rate_mean_without_residuals","estimated_bc","estimated_bc_without_residuals",  "comments" and any columns after,
+ removes all replicated samples tested after J-9, etc... /ex 'Hip_B_046-J12'
+ removes empty raws after 233rd row
+ removes raws corresponding to Buffalo_01 --> a test sample that wasn't harvested following the study design (but opportunistically) and  must, thus, be excluded because it wasn't
+ removes raws corresponding to hyena's data or with no information on predator species (NA)

The function include an option to save the cleaned dataset, the user must specified 'save = TRUE', and the filename under which the file must be saved. The cleaned dataset is saved under ./output/clean_fat_data/ 


```{r}

clean_fat_data <- clean_raw_fat_data(fat_data_raw,
                                     save = T,
                                     filename = 'cleaned_fat_data')
```


<!-- __Save cleaned dataset__ -->

<!-- Aim at saving cleaned data for fat analyses 'save_cleaned_data' -->

<!-- The function takes 2 arguments :    -->

<!-- +  _cleaned_data_ : cleaned raw data for fat analyses (after using clean_raw_fat_data function) -->
<!-- + _filename_ : the name we want the dataset to be saved under -->

<!-- The cleaned dataset is saved under ./output/clean_fat_data/  -->

<!-- <br> -->
<!-- <br> -->

## Data Exploration 
<br>

### __I Within sample variability__

<br>

Across all species, and conditions. 


<br>

#### A)  Replicate's dry mass 



<br> 

Graphical representation of the spread/distribution of dry-mass values for each sample (i.e. sample_ID: Hip_B_...etc)
Each boxplots represent the up to five dry masses values obtained for each carcass

<br>

```{r, echo=FALSE, out.width="100%", fig.align = 'center'}

get_dry_mass_boxplot(tab = clean_fat_data,
                     save = F)


```

<br>

Table with coefficients of variation calculated per sample_ID
Mean, sd and CV are calculated from the up to five dry mass values from each carcasses (<=> sample_ID) 

<br>

```{r, echo = FALSE}

 get_CV_dry_mass_table(clean_fat_data,
                       save = F) %>% 
 kableExtra::kbl() %>% 
   kableExtra::kable_styling() %>% 
   kableExtra::scroll_box(width = "100%", height = "250px")


```

<br>

CV < 1 i.e. SD < mean --> relatively low variability ? (cf https://statisticsbyjim.com/basics/coefficient-variation/ )

<br>

#### B)  Replicate's fat rate 


<br> 

Graphical representation of the spread/distribution of fat rate values for each sample (i.e. sample_ID: Hip_B_...etc)
The fat rate was calculated as follows : 

$$\frac{Sd}{Mean}$$
for each replicates (i.e. each raw in the original table & there are as many fat-rate values as there are of replicated per sample_ID)

<br>

```{r}
get_fat_rate_boxplot(clean_fat_data,
                     save =  F)
```
<br>
<br>

Table with coefficients of variation calculated per sample_ID
<br>

<br>

```{r}
 CV_fat_rate_table <- get_CV_fat_rate_table(clean_fat_data,
                       save = F) 

CV_fat_rate_table %>% 
  kableExtra::kbl() %>% 
   kableExtra::kable_styling() %>% 
   kableExtra::scroll_box(width = "100%", height = "250px")
```

<br>

```{r}
get_fat_rate_CV_hist(tab = CV_fat_rate_table,
                     save = F)
```

There are 3 samples that stands out !

<br>

```{r}
 get_high_CV_table(tab = clean_fat_data,
                  CV_fat_rate_table = CV_fat_rate_table,
                  value = 0.25,
                  save = F) %>% 
   kableExtra::kbl() %>% 
   kableExtra::kable_styling() %>% 
   kableExtra::scroll_box(width = "100%", height = "250px")
```

<br>

The samples with the highest coefficient of variation (> 0.25) are HiP_B_012, HiP_B_022, HiP_B_055. All them should be included in the 'golden standard' analysis.

<br>
<br>

### __II Fat rate analyses__

<br>
<br>

#### A) 'Gold standard' analyses ####

<br>

```{r}
#> data preparation ####

gs_data <- get_gs_data(clean_fat_data)

```

##### Carcass number summary tables 

<br> 

Number of carcasses (i.e. sample ID) per species, month (cluster_month), season, and season & species

<br> 

_Per species_

<br> 

```{r}
get_nb_carcass_table(gs_data,
                    carcass_species) %>% 
 kableExtra::kbl() %>% 
   kableExtra::kable_styling()
```

_Per cluster_month_

<br> 

```{r}
get_nb_carcass_table(gs_data,
                     cluster_month) %>% 
 kableExtra::kbl() %>% 
   kableExtra::kable_styling()

```

_Per species & cluster_month_

<br> 

```{r}
#per specie & per month
get_nb_carcass_table(gs_data,
                     carcass_species,cluster_month) %>% #... = cluster_month
kableExtra::kbl() %>% 
   kableExtra::kable_styling() %>% 
   kableExtra::scroll_box(width = "100%", height = "250px") 

```


<br>
<br>

***

Following discussion with Marion, I have tested for 2 ways of dividing season  

+ __season 1__: lean (season): 7-10 (july-october), productive (season): 1-6 & 11,12 , or
+ __season 2__: early_dry : 1-7, dry: 7-12 

***
<br>
<br>

_Per Season 1_

<br> 

```{r}
get_nb_carcass_table(gs_data,
                     season1) %>% 
 kableExtra::kbl() %>% 
   kableExtra::kable_styling()

```

_Per Season 2_

<br> 

```{r}
#per season 2
get_nb_carcass_table(gs_data,
                     season2)  %>% 
 kableExtra::kbl() %>% 
   kableExtra::kable_styling()
```


_Per species & season 1_

<br> 

```{r}
#per species & season 1
get_nb_carcass_table(gs_data,
                     carcass_species,season1) %>% #... = carcass_species, season1
 kableExtra::kbl() %>% 
   kableExtra::kable_styling() %>% 
   kableExtra::scroll_box(width = "100%", height = "250px") 

```

_Per species and season 2_

<br> 

```{r}
#per species & season 2
get_nb_carcass_table(gs_data,
                     carcass_species,season2) %>% #... = carcass_species, season1
 kableExtra::kbl() %>% 
   kableExtra::kable_styling() %>% 
   kableExtra::scroll_box(width = "100%", height = "250px") 
```

<br> 

<!-- Since it seems that season 1 allows for more balanced categories, and their is no difference for the number of carcasses per species per season1/season 2,  -->

I'll use a the 'season 1' way to divide the year afterwards

<br> 
<br> 

##### Graphical representation (Boxplots)

<br> 

***

For analyses below

+ The fat rate values of each replicates (i.e. each raw in the original table :  there are as many fat-rate values as there are of replicates per sample_ID - i.e. up to 5)
+ The mean fat rate is computed over the (up to) 5 replicates per sample, so we have one value per sample_ID. 
+ When looking at species of interest, I only kept the species with the highest number of carcasses + carcasses in both season / over several months

***

<br> 

###### _Per month_  

<br>

__Fat rate as a function of month (cluster_month), all species__

<br>


```{r, echo=FALSE, out.width="100%",fig.align = 'center'}

boxplot_all_sp (tab = gs_data,
                varx = 'cluster_month' ,
                vary = 'sample_replicate_fat_rate' )

```

<br>

__Fat rate as a function of month (cluster_month), Buffalo, Nyala & Warthog__

<br>


```{r}

boxplot_main_sp(tab = gs_data,
                            varx = 'cluster_month' ,
                            vary ='sample_replicate_fat_rate',
                            species_vec = c('buffalo', 'nyala', 'warthog')) 


```


<br>

__Mean fat rate as a function of month (cluster_month), (replicate level), all species__

<br>


```{r, echo=FALSE, out.width="100%",fig.align = 'center'}

# data preparation, compute the mean fat rate per sample_ID & per species
gs_data %>%
  dplyr::group_by(samples_ID, cluster_start_date, cluster_month) %>%
  dplyr::summarise(mean_fat_rate = mean(sample_replicate_fat_rate)) %>%

  boxplot_all_sp (tab = .,
                  varx = 'cluster_month' ,
                  vary = 'mean_fat_rate' )

```

<br>

__Mean fat rate as a function of month (cluster_month), (replicate level), Buffalo, Nyala & Warthog__

<br>

```{r, echo=FALSE, out.width="100%",fig.align = 'center'}

# data preparation, compute the mean fat rate per sample_ID & per species
gs_data %>%
  dplyr::group_by(samples_ID, cluster_start_date, cluster_month, carcass_species ) %>%
  dplyr::summarise(mean_fat_rate = mean(sample_replicate_fat_rate)) %>%
  #dplyr::filter(carcass_species %in% c('buffalo', 'nyala', 'warthog')) %>%

  boxplot_main_sp( tab = .,
                   varx= 'cluster_month',
                   vary= 'mean_fat_rate',
                   species_vec = c('buffalo', 'nyala', 'warthog'))

```


###### _Per season_ 

<br>

Since season 1 is more balanced than season 2, I use 'season1' (lean - july to october- vs productive season)

<br>

__Fat rate as a function of season 1, all species__

```{r}

#fat rate value ~ season1 (early dry = 2-6 & dry = 7-11), all sp

boxplot_all_sp (tab = gs_data,
                varx = 'season1' ,
                vary = 'sample_replicate_fat_rate' )


```

<br>

__Fat rate as a function of season 1, Buffalo, Nyala & Warthog__

<br>


```{r}
# fat rate value ~ season1 (lean vs productive), main sp

boxplot_main_sp(tab = gs_data,
                varx = 'season1' ,
                vary ='sample_replicate_fat_rate',
                species_vec = c('buffalo', 'nyala', 'warthog'))

```

<br>

__Mean fat rate as a function of season 1, all species__

<br>

```{r}
# mean fat rate ~ season 1 all sp

# data preparation, compute the mean fat rate per sample_ID & per season1
gs_data %>%
  dplyr::group_by(samples_ID, cluster_start_date, cluster_month, season1) %>%
  dplyr::summarise(mean_fat_rate = mean(sample_replicate_fat_rate)) %>%

  boxplot_all_sp (tab = .,
                  varx = 'season1' ,
                  vary = 'mean_fat_rate' )

```

<br>

__Mean fat rate as a function of season 1, Buffalo, Nyala & Warthog__

<br>

```{r}
# mean fat rate ~ season 1 main sp

# data preparation, compute the mean fat rate per sample_ID, per season1 & per species

gs_data %>%
  dplyr::group_by(samples_ID, cluster_start_date, cluster_month, carcass_species, season1 ) %>%
  dplyr::summarise(mean_fat_rate = mean(sample_replicate_fat_rate)) %>%
  dplyr::filter(carcass_species %in% c('buffalo', 'nyala', 'warthog')) %>%

  boxplot_main_sp( tab = .,
                   varx= 'season1',
                   vary= 'mean_fat_rate',
                   species_vec = c('buffalo', 'nyala', 'warthog'))

```

##### Statistical Analyses (exploratory)

```{r}
# >> statistical analyses (exploratory) ####

data_tab <-

  gs_data %>%
  dplyr::group_by(samples_ID, cluster_start_date, cluster_month, season1) %>%
  dplyr::summarise(mean_fat_rate = mean(sample_replicate_fat_rate)) %>%
  dplyr::ungroup() %>%
  dplyr::select(samples_ID, season1, mean_fat_rate)

```

  
_Question_ : is there an effect of the season on the (mean?) fat rate of the prey killed by lions ?

+ Explanatory variable : season, qualitative, 2 levels : lean vs productive 
+ Response variable : mean fat rate, quantitative  
  
Data structure : 
```{r, include = TRUE}

#Question: is there an effect of the season on the (mean?) fat rate of the prey killed by lions ?

# explanatory variable : season 1 : qualitative, 2 levels 
# Response variable : mean fat rate : quantitative

str(data_tab)
summary(data_tab)

```
  
Graphical representation of the data :  

```{r, include = TRUE}

boxplot(data_tab$mean_fat_rate ~ data_tab$season1 )
plot(data_tab$mean_fat_rate)

```
  
  Are the data normally distributed ?
```{r, include = TRUE}

# Normality ?
hist(data_tab$mean_fat_rate, breaks = 26)
shapiro.test(data_tab$mean_fat_rate)

```

<br>
According to the results of the shapiro test (p-value significative) and histogram above, the data are not normally distributed, which calls for non parametric test (?)

<br>  

We compare 2 samples (2 treatments) --> Wilcoxon-Man-Whitney test :     

<br>  

```{r, include = TRUE}

# data do not follow a normal distribution --> non parametric tests
# --> Wilcoxon Man Whitney :

wm1<- wilcox.test(data_tab$mean_fat_rate ~ data_tab$season1)
wm1

```

<!-- <br> -->

<!-- I have also made an ANOVA (as discussed) : -->

<!-- <br> -->

<!-- Model : mean fate rate ~ season (2 level : early dry & dry)  -->

<!-- <br> -->

<!-- ```{r, include = TRUE} -->
<!-- #test ANOVA or 2-sample t-test -->

<!-- #ANOVA model -->
<!-- lm1 <- lm(data_tab$mean_fat_rate ~ data_tab$season1,data = data_tab ) #Yi = mu + alpha_i -->
<!-- summary(lm1) -->

<!-- ``` -->

<!-- <br> -->

<!-- Model test  -->

<!-- <br> -->

<!-- ```{r, include = TRUE} -->
<!-- # Model test -->
<!-- lm0 <- lm( data_tab$mean_fat_rate ~ 1)# Null model  -->

<!-- anova(lm0, lm1) # comparison between model null and model 1 -->

<!-- ``` -->

<!-- <br>  -->

<!-- Apparently the lm1 model does not do better than the null model -->

<!-- <br>  -->

<!-- _Parameters' test_  -->

<!-- ```{r, include = TRUE} -->
<!-- anova(lm1) -->
<!-- ``` -->

<!-- <br>  -->
<!-- <br>  -->

<!-- Since the data aren't normally distributed, maybe we should try data transformation ? -->

<!-- <br>  -->

<!-- ```{r, include = TRUE} -->
<!-- # Data transformation ? -->

<!-- hist(log(data_tab$mean_fat_rate), breaks = 26) -->
<!-- hist(sqrt(data_tab$mean_fat_rate), breaks = 26) -->


<!-- ``` -->



#### B) Larger sample analyses

<br>

Include sub-adult in addition to adult & old individuals, with bones collected before 6 days and within 6 to 8 days  
  
_(Coming soon)_


<br>


### __III Body condition analyses__

#### A) 'Gold standard' analyses 

<br>

_Data preparation_

sample's mean fat rates have been translated into categorical variable 'body_condition', as follows : 

+ fat rate < 0.20 : emaciated
+ 0.20 < fat rate < 0.70 
+ fat rate > 0.70


(NB: I need to correct codes with =</ >= etc...) 

```{r}

# data preparation 

bc_gs_data <- get_body_condition_data_gs(tab = clean_fat_data,
                           save =  T)

```

<br>

```{r}

#> Option 1 - bc ~ season facet with season  ####

bc_season_bp_op1(tab = bc_gs_data,
                 save = T)

```
<br>

Number of emaciated carcasses/individuals lower during productive season, increase during dry season.  
We observe the reverse for the thin and good carcasses/individual.  
--> Proportion of emaciated individual lean season > productive season ?  

<br>

Per species 

<br>

Buffalo

<br> 

```{r}
#buffalo
bc_season_bp_op1_sp(tab = bc_gs_data,
                    sp = 'buffalo',
                    save = FALSE)

```

<br> 

Warthog

<br> 

```{r}
#warthog
bc_season_bp_op1_sp(tab = bc_gs_data,
                    sp = 'warthog',
                    save = FALSE)
```

<br> 

Nyala

<br> 

```{r}                    
#warthog
bc_season_bp_op1_sp(tab = bc_gs_data,
                    sp = 'nyala',
                    save = FALSE)
```



```{r}

#> Option 2 - bc ~ season facet with bc  ####

 bc_season_bp_op2(tab = bc_gs_data,
                  save = T)

```

<br> 

More emaciated individuals/carcasses (<20) during lean vs productive.   
We observed the reverse for good condition carcasses/ indiv (>70) in productive vs lean season.  
Thin individuals.carcasses : only a small change.  


2 qualitative variables --> chi square test ? 

<br>

Per species 

<br>

Buffalo

<br> 

```{r}
#buffalo
bc_season_bp_op2_sp(tab = bc_gs_data,
                    sp = 'buffalo',
                    save = FALSE)

```

<br> 

Warthog

<br> 

```{r}
#warthog
bc_season_bp_op2_sp(tab = bc_gs_data,
                    sp = 'warthog',
                    save = FALSE)
```

<br> 

Nyala

<br> 

```{r}                    
#warthog
bc_season_bp_op2_sp(tab = bc_gs_data,
                    sp = 'nyala',
                    save = FALSE)
```
